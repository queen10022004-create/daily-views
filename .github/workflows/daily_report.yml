name: YouTube Views Tracker Daily

on:
  schedule:
    - cron: '0 0 * * *' # Cháº¡y 7h sÃ¡ng háº±ng ngÃ y
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run_analytics_and_email:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: pip install -r requirements.txt

      - name: Run Python Script
        env:
          API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
        run: python youtube_tool.py
      - name: 5. Debug & Commit
        run: |
          # --- Lá»†NH KIá»‚M TRA Má»šI ---
          echo "ğŸ“‚ Äang liá»‡t kÃª cÃ¡c file trong thÆ° má»¥c hiá»‡n táº¡i:"
          ls -R
          # -------------------------

          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Thá»­ add file, náº¿u khÃ´ng cÃ³ file thÃ¬ khÃ´ng bÃ¡o lá»—i Ä‘á» lÃ²m ná»¯a mÃ  chá»‰ bÃ¡o warning
          git add *.csv || echo "âš ï¸ Cáº£nh bÃ¡o: KhÃ´ng tÃ¬m tháº¥y file CSV nÃ o Ä‘á»ƒ add!"
          
          # Chá»‰ commit náº¿u cÃ³ sá»± thay Ä‘á»•i
          git diff --staged --quiet || git commit -m "ğŸ“Š Auto-update stats [skip ci]"
          git push origin main
      - name: Commit & Push Data back to GitHub
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add *.csv
          git commit -m "ğŸ“Š Auto-update stats [skip ci]" || echo "No changes to commit"
          git push origin main

      # --- PHáº¦N Má»šI: Gá»¬I EMAIL ---
      - name: Send mail
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: ğŸ“Š BÃ¡o cÃ¡o YouTube HÃ ng NgÃ y
          body: |
            ChÃ o báº¡n,
            
            ÄÃ¢y lÃ  bÃ¡o cÃ¡o thá»‘ng kÃª lÆ°á»£t xem kÃªnh YouTube cá»§a báº¡n ngÃ y hÃ´m nay.
            File chi tiáº¿t Ä‘Æ°á»£c Ä‘Ã­nh kÃ¨m bÃªn dÆ°á»›i.
            
            TrÃ¢n trá»ng,
            GitHub Bot
          to: ${{ secrets.MAIL_USERNAME }} # Gá»­i cho chÃ­nh mÃ¬nh
          from: YouTube Tracker Bot
          attachments: history_*.csv # Tá»± Ä‘á»™ng tÃ¬m file csv Ä‘á»ƒ Ä‘Ã­nh kÃ¨m
