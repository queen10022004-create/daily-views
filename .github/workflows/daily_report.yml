name: YouTube Views Tracker Daily

on:
  schedule:
    - cron: '0 0 * * *' # Ch·∫°y 7h s√°ng h·∫±ng ng√†y
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run_analytics_and_email:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: pip install -r requirements.txt

      - name: Run Python Script
        env:
          API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
        run: python youtube_tool.py

      - name: Commit & Push Data back to GitHub
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add *.csv
          git commit -m "üìä Auto-update stats [skip ci]" || echo "No changes to commit"
          git push origin main

      # --- PH·∫¶N M·ªöI: G·ª¨I EMAIL ---
      - name: Send mail
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: üìä B√°o c√°o YouTube H√†ng Ng√†y
          body: |
            Ch√†o b·∫°n,
            
            ƒê√¢y l√† b√°o c√°o th·ªëng k√™ l∆∞·ª£t xem k√™nh YouTube c·ªßa b·∫°n ng√†y h√¥m nay.
            File chi ti·∫øt ƒë∆∞·ª£c ƒë√≠nh k√®m b√™n d∆∞·ªõi.
            
            Tr√¢n tr·ªçng,
            GitHub Bot
          to: ${{ secrets.MAIL_USERNAME }} # G·ª≠i cho ch√≠nh m√¨nh
          from: YouTube Tracker Bot
          attachments: history_*.csv # T·ª± ƒë·ªông t√¨m file csv ƒë·ªÉ ƒë√≠nh k√®m
